name: Build and Release TrollScript

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  repository_dispatch:
    types: [build_release]

permissions:
  contents: write  # å…è®¸åˆ›å»º Release å’Œ Tag

jobs:
  build:
    runs-on: macos-15
    steps:
      # 1. æ‹‰å–å½“å‰ Release ä»“åº“
      - name: Checkout Release Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_TOKEN }}
      
      # 2. ä½¿ç”¨ GH_TOKEN æ‹‰å–ç§æœ‰ä»“åº“ TROLLSTORE
      - name: Checkout Private TrollScript Repository
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.TROLLSTORE }}
          token: ${{ secrets.GH_TOKEN }}
          path: TrollScript-Private
          fetch-depth: 0

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: 'latest-stable'

      - name: Show Xcode version
        run: |
          xcodebuild -version
          xcode-select -p

      - name: Cache Swift Package Manager
        uses: actions/cache@v4
        with:
          path: |
            build/SourcePackages
            ~/Library/Caches/org.swift.swiftpm
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Install ldid (iOS signing tool)
        run: |
          brew install ldid
          ldid -h || true
          echo "ldid installed successfully"
      
      # 4. ä»ç§æœ‰ä»“åº“ tag æ›´æ–°ç‰ˆæœ¬å·
      - name: Update version from tag
        working-directory: TrollScript-Private
        run: |
          INFO_PLIST="TrollScript/Info.plist"

          # è·å–æœ€æ–° tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -n "$LATEST_TAG" ]; then
            # ä» tag æå–ç‰ˆæœ¬å·ï¼Œå»æ‰ v å‰ç¼€
            VERSION="${LATEST_TAG#v}"
            echo "âœ… ä» tag æå–ç‰ˆæœ¬å·: $VERSION"
          else
            # å°è¯•è·å–å½“å‰ commit çš„ tag
            CURRENT_TAG=$(git describe --tags --exact-match 2>/dev/null || echo "")
            if [ -n "$CURRENT_TAG" ]; then
              VERSION="${CURRENT_TAG#v}"
              echo "âœ… ä»å½“å‰ commit tag æå–ç‰ˆæœ¬å·: $VERSION"
            else
              # æ²¡æœ‰ tagï¼Œä¿æŒ Info.plist ä¸­çš„ç‰ˆæœ¬ä¸å˜
              echo "âš ï¸ æ—  tagï¼Œä¿æŒåŸç‰ˆæœ¬å·ä¸å˜"
              exit 0
            fi
          fi

          # ç”Ÿæˆæ„å»ºå·ï¼ˆä½¿ç”¨æ—¶é—´æˆ³ï¼‰
          BUILD_NUMBER=$(date +'%Y%m%d%H%M')

          # æ›´æ–° Info.plist
          echo "ğŸ“ æ›´æ–° Info.plist:"
          echo "   CFBundleShortVersionString: $VERSION"
          echo "   CFBundleVersion: $BUILD_NUMBER"

          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString $VERSION" "$INFO_PLIST"
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $BUILD_NUMBER" "$INFO_PLIST"

          # éªŒè¯æ›´æ–°
          echo "âœ… æ›´æ–°åçš„ç‰ˆæœ¬ä¿¡æ¯:"
          /usr/libexec/PlistBuddy -c "Print :CFBundleShortVersionString" "$INFO_PLIST"
          /usr/libexec/PlistBuddy -c "Print :CFBundleVersion" "$INFO_PLIST"
      
      # 5. è¿›å…¥ç§æœ‰ä»“åº“ç›®å½•ï¼Œè¿è¡Œ build-tipa.sh
      - name: Build TrollScript
        working-directory: TrollScript-Private
        run: |
          chmod +x scripts/build-tipa.sh
          ./scripts/build-tipa.sh
      
      # 5. å¤åˆ¶ release æ–‡ä»¶å¤¹åˆ°æœ¬é¡¹ç›®
      - name: Copy Build Artifacts to Release Repository
        run: |
          mkdir -p release
          cp -r TrollScript-Private/release/* release/
          
          echo "ğŸ“¦ Build artifacts:"
          ls -la release/
      
      # 6. è·å–ç§æœ‰ä»“åº“æœ€å tag çš„ commit ä¿¡æ¯
      - name: Get Version Info from Private Repository
        id: version
        working-directory: TrollScript-Private
        run: |
          # è·å–æœ€æ–° tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$LATEST_TAG" ]; then
            LATEST_TAG="v0.0.0-$(git rev-parse --short HEAD)"
            echo "âš ï¸ No tag found, using: $LATEST_TAG"
          fi
          
          # è·å– tag å¯¹åº”çš„ commit ä¿¡æ¯
          if git rev-parse "$LATEST_TAG" >/dev/null 2>&1; then
            COMMIT_MSG=$(git log -1 --pretty=format:"%B" "$LATEST_TAG" 2>/dev/null || echo "New release")
          else
            COMMIT_MSG=$(git log -1 --pretty=format:"%B" 2>/dev/null || echo "New release")
          fi
          
          COMMIT_SHORT=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
          COMMIT_HASH=$(git rev-parse HEAD 2>/dev/null || echo "")
          
          echo "release_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "commit_short=$COMMIT_SHORT" >> $GITHUB_OUTPUT
          echo "commit_hash=$COMMIT_HASH" >> $GITHUB_OUTPUT
          
          # å¤„ç†å¤šè¡Œ commit æ¶ˆæ¯
          EOF_MARKER=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
          echo "commit_msg<<$EOF_MARKER" >> $GITHUB_OUTPUT
          echo "$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "$EOF_MARKER" >> $GITHUB_OUTPUT
          
          echo "ğŸ“Œ Release Tag: $LATEST_TAG"
          echo "ğŸ“Œ Commit: $COMMIT_SHORT"
          echo "ğŸ“Œ Commit Message:"
          echo "$COMMIT_MSG"
      
      # 7. åˆ›å»º Release Notes
      - name: Create Release Notes
        run: |
          RELEASE_TAG="${{ steps.version.outputs.release_tag }}"
          COMMIT_MSG="${{ steps.version.outputs.commit_msg }}"
          COMMIT_SHORT="${{ steps.version.outputs.commit_short }}"
          
          cat > release-notes.md << EOF
          **TrollScript $RELEASE_TAG**
          
          ## ğŸ“‹ $(date -u '+%Y-%m-%d %H:%M:%S UTC') æ›´æ–°å†…å®¹
          
          $COMMIT_MSG
          
          ---
          
          > Commit: \`$COMMIT_SHORT\`
          EOF
          
          echo "ğŸ“ Release Notes:"
          cat release-notes.md
      
      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: TrollScript-${{ steps.version.outputs.release_tag }}
          path: release/*.tipa
          retention-days: 30
      
      # 8. åœ¨æœ¬é¡¹ç›®åˆ›å»º Tag å¹¶æäº¤åˆ° Release
      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RELEASE_TAG="${{ steps.version.outputs.release_tag }}"
          
          # æŸ¥æ‰¾ TIPA æ–‡ä»¶
          TIPA_FILE=$(find ./release -name "*.tipa" ! -name "*_latest.tipa" 2>/dev/null | head -1 || echo "")
          LATEST_FILE="./release/TrollScript_latest.tipa"
          
          if [ -z "$TIPA_FILE" ]; then
            echo "âŒ No TIPA file found"
            exit 1
          fi
          
          echo "ğŸ“¦ Found TIPA: $TIPA_FILE"

          # åˆ é™¤å·²å­˜åœ¨çš„ releaseï¼ˆå¦‚æœæœ‰ï¼‰
          if gh release view "$RELEASE_TAG" &>/dev/null; then
            echo "âš ï¸ Release $RELEASE_TAG exists, deleting..."
            gh release delete "$RELEASE_TAG" --yes || true
            # åˆ é™¤å¯¹åº”çš„ tag
            git push origin :refs/tags/$RELEASE_TAG 2>/dev/null || true
          fi

          # åˆ›å»ºæ–° releaseï¼ˆåªä¸Šä¼ ç‰ˆæœ¬å·æ–‡ä»¶ï¼‰
          gh release create "$RELEASE_TAG" \
            "$TIPA_FILE" \
            --title "ğŸ§™ TrollScript $RELEASE_TAG" \
            --notes-file release-notes.md \
            --draft=false \
            --prerelease=false
          
          echo "âœ… Release $RELEASE_TAG created!"
          
          # æ›´æ–° latest release
          echo "ğŸ“Œ Updating latest release..."
          if gh release view "latest" &>/dev/null; then
            gh release delete "latest" --yes || true
          fi
          # åˆ é™¤è¿œç¨‹å’Œæœ¬åœ°çš„ latest tag
          git push origin :refs/tags/latest 2>/dev/null || true
          git tag -d latest 2>/dev/null || true
          
          gh release create "latest" \
            "$LATEST_FILE" \
            --title "ğŸ§™ TrollScript Latest $RELEASE_TAG" \
            --notes-file release-notes.md \
            --draft=false \
            --prerelease=false
          
          echo "âœ… Latest release updated!"
