name: Deploy Documentation

on:
  push:
    branches:
      - main  # ç›‘å¬ä¸»åˆ†æ”¯æ¨é€
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  repository_dispatch:
    types: [build_pages]

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. ä½¿ç”¨ GH_TOKEN æ‹‰å–ç§æœ‰ä»“åº“ TROLLSTORE
      - name: Checkout Private TrollScript Repository
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.TROLLSTORE }}
          token: ${{ secrets.GH_TOKEN }}
          path: TrollScript-Private
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.x

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          registry-url: 'https://registry.npmjs.org'

      # 3. ç”Ÿæˆ API æ–‡æ¡£å’Œ NPM åŒ…
      - name: Generate API Documentation and NPM Package
        run: |
          echo "ğŸ“‹ Generating API documentation..."

          if [ -d "TrollScript-Private/JSModulesAPI" ]; then
            # Generate API.md from split module directories
            python3 TrollScript-Private/scripts/generate_api_docs.py TrollScript-Private/JSModulesAPI/zh ./API.md
            python3 TrollScript-Private/scripts/generate_api_docs.py TrollScript-Private/JSModulesAPI/en ./API.en.md
            echo "âœ… Generated API.md and API.en.md"

            # Generate NPM Package with auto-incrementing version
            mkdir -p npm

            # è·å–å½“å‰ NPM åŒ…çš„æœ€æ–°ç‰ˆæœ¬
            CURRENT_VERSION=$(npm view @dompling/trollscript-types version 2>/dev/null || echo "1.0.0")
            echo "ğŸ“‹ Current NPM version: $CURRENT_VERSION"

            # æå– patch ç‰ˆæœ¬å·å¹¶é€’å¢
            PATCH_VERSION=$(echo $CURRENT_VERSION | cut -d. -f3)
            NEW_PATCH=$((PATCH_VERSION + 1))
            PACKAGE_VERSION="1.0.$NEW_PATCH"
            echo "ğŸ“‹ New version: $PACKAGE_VERSION"

            python3 TrollScript-Private/scripts/generate_npm_package.py TrollScript-Private/JSModulesAPI/zh ./npm $PACKAGE_VERSION
            echo "âœ… Generated NPM package (v$PACKAGE_VERSION) in npm/"
          else
            echo "âš ï¸ JSModulesAPI directory not found"
          fi

      # æ£€æŸ¥ API æ˜¯å¦æœ‰å˜åŒ–
      - name: Check if API changed
        id: check_api
        run: |
          API_CHANGED="false"

          # Check if API.md exists and has changes
          if [ -f "API.md" ]; then
            # Compare with git to see if there are changes
            if ! git diff --quiet API.md 2>/dev/null; then
              API_CHANGED="true"
            fi
          else
            # If API.md doesn't exist yet, consider it as changed
            API_CHANGED="true"
          fi

          echo "api_changed=$API_CHANGED" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ API changed: $API_CHANGED"

      # å‘å¸ƒ NPM åŒ…ï¼ˆä»…åœ¨ API æœ‰å˜åŒ–æ—¶ï¼‰
      - name: Publish NPM Package
        if: success() && steps.check_api.outputs.api_changed == 'true'
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          if [ ! -d "npm" ]; then
             echo "âš ï¸ Skipping NPM publish: Directory npm/ not found"
             exit 0
          fi

          if [ -z "$NODE_AUTH_TOKEN" ]; then
             echo "âš ï¸ Skipping NPM publish: NODE_AUTH_TOKEN is empty. Please check if NPM_TOKEN secret is set correctly."
             exit 0
          fi

          cd npm
          echo "ğŸ“¦ Publishing to NPM..."
          npm publish --access public
          echo "âœ… Published successfully"

      # 4. å¤åˆ¶ç§æœ‰ä»“åº“çš„æ–‡ä»¶åˆ°å½“å‰ä»“åº“
      - name: Copy files from Private Repository
        run: |
          echo "ğŸ“‹ Starting file sync from private repository..."

          # Sync templates directory
          if [ -d "TrollScript-Private/templates" ]; then
            rm -rf templates
            cp -r TrollScript-Private/templates ./
            echo "âœ… Synced templates/"
          else
            echo "âš ï¸ templates/ not found in private repository"
          fi

          # Sync README.md
          if [ -f "TrollScript-Private/templates/README.md" ]; then
            cp TrollScript-Private/templates/README.md ./
            echo "âœ… Synced README.md"
          else
            echo "âš ï¸ README.md not found in private repository"
          fi

      # 5. æäº¤æ›´æ”¹åˆ°å½“å‰ä»“åº“
      - name: Commit and Push changes
        if: success()
        run: |
          echo "ğŸ“‹ Checking for changes..."

          # Check if there are changes
          if [ -n "$(git status --porcelain)" ]; then
            git config --local user.email "github-actions[bot]@users.noreply.github.com"
            git config --local user.name "github-actions[bot]"

            git add -A
            git commit -m "ğŸ”„ Sync from private repository - $(date '+%Y-%m-%d %H:%M:%S')"
            git push

            echo "âœ… Changes committed and pushed"
          else
            echo "â„¹ï¸ No changes to commit"
          fi

      - name: Install dependencies
        run: |
          pip install mkdocs-material

      - name: Prepare Workspace
        run: |
          mkdir -p docs
          cp *.md docs/
          cp templates/*.md docs/
          cp templates/API/*.md docs/
          cp -r AppIcon.png docs/
          cp -r images docs/
          cp -r CNAME docs/
          

      - name: Build and Deploy
        run: mkdocs gh-deploy --force